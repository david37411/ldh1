<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title> ì¶”ì„¸ ì¶”ì¢… ì „ëµ ì‹œê°í™”</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
        body { font-family: sans-serif; padding: 2em; }
        #chartContainer { width: 100%; height: 500px; }
        #error { color: red; margin-top: 10px; white-space: pre-line; }
    </style>
</head>
<body>
    <h2>ğŸ“ˆ ì¶”ì„¸ ì¶”ì¢… ì „ëµ ì‹œê°í™”</h2>
    <p>CSV íŒŒì¼ì„ ì—…ë¡œë“œí•˜ë©´ ì´ë™í‰ê· ì„ ê³¼ ë§¤ìˆ˜/ë§¤ë„ ì‹œì ì„ ì‹œê°í™”í•©ë‹ˆë‹¤.</p>
    <input type="file" id="fileInput" accept=".csv">
    <div id="error"></div>
    <canvas id="stockChart"></canvas>

    <script>
        const ctx = document.getElementById('stockChart').getContext('2d');
        const fileInput = document.getElementById('fileInput');
        const errorDiv = document.getElementById('error');
        let chart;

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            errorDiv.textContent = 'ğŸ“„ íŒŒì¼ ì—…ë¡œë“œ ì™„ë£Œ: ' + file.name;
            Papa.parse(file, {
                header: false,
                skipEmptyLines: true,
                complete: (results) => {
                    const rows = results.data;
                    if (rows.length < 2) {
                        errorDiv.textContent += 'â— ìœ íš¨í•œ ë°ì´í„°ê°€ í¬í•¨ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.';
                        return;
                    }
                    const data = rows.map(row => ({ ì¼ì: row[0], ì¢…ê°€: row[1] })).filter(row => row.ì¼ì && !isNaN(parseFloat(row.ì¢…ê°€)));
                    if (!data.length) {
                        errorDiv.textContent += 'â— ë°ì´í„°ê°€ ë¹„ì–´ ìˆê±°ë‚˜ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
                        return;
                    }
                    visualize(data);
                },
                error: (err) => {
                    errorDiv.textContent = 'CSV íŒŒì¼ íŒŒì‹± ì˜¤ë¥˜: ' + err.message;
                }
            });
        });

        function visualize(data) {
            const analysisDiv = document.createElement('div');
            analysisDiv.style.marginTop = '20px';
            document.body.appendChild(analysisDiv);
            const labels = data.map(row => row['ì¼ì']).reverse();
            const closePrices = data.map(row => parseFloat(row['ì¢…ê°€'])).reverse();

            function calcSMA(prices, period) {
                return prices.map((_, i, arr) => {
                    if (i < period - 1) return null;
                    const slice = arr.slice(i - period + 1, i + 1);
                    return slice.reduce((a, b) => a + b, 0) / period;
                });
            }

            const sma10 = calcSMA(closePrices, 10);
            const sma40 = calcSMA(closePrices, 40);

            const buySignals = [];
            const sellSignals = [];
            for (let i = 1; i < data.length; i++) {
                if (sma10[i] !== null && sma40[i] !== null) {
                    if (sma10[i] > sma40[i] && sma10[i - 1] <= sma40[i - 1]) {
                        buySignals.push({ x: labels[i], y: closePrices[i] });
                    } else if (sma10[i] < sma40[i] && sma10[i - 1] >= sma40[i - 1]) {
                        sellSignals.push({ x: labels[i], y: closePrices[i] });
                    }
                }
            }

            if (chart) chart.destroy();

            // ìˆ˜ìµë¥  ë° ë³´ìœ ê¸°ê°„ ë¶„ì„
            const trades = [];
            let position = null;
            for (let i = 0; i < labels.length; i++) {
                const date = labels[i];
                const price = closePrices[i];
                if (buySignals.some(p => p.x === date)) {
                    position = { buyDate: date, buyPrice: price, buyIndex: i };
                }
                if (position && sellSignals.some(p => p.x === date)) {
                    const profit = price - position.buyPrice;
                    const returnRate = ((price - position.buyPrice) / position.buyPrice) * 100;
                    const holdDays = i - position.buyIndex;
                    trades.push({ ...position, sellDate: date, sellPrice: price, profit, returnRate, holdDays });
                    position = null;
                }
            }

            const totalTrades = trades.length;
            const avgHold = (trades.reduce((acc, t) => acc + t.holdDays, 0) / totalTrades || 0).toFixed(1);
            const avgReturn = (trades.reduce((acc, t) => acc + t.returnRate, 0) / totalTrades || 0).toFixed(2);

            analysisDiv.innerHTML = `
              <h3>ğŸ“Š ì „ëµ ë¶„ì„ ê²°ê³¼</h3>
              <p>ì´ ê±°ë˜ íšŸìˆ˜: <strong>${totalTrades}</strong></p>
              <p>í‰ê·  ë³´ìœ  ê¸°ê°„: <strong>${avgHold}ì¼</strong></p>
              <p>í‰ê·  ìˆ˜ìµë¥ : <strong>${avgReturn}%</strong></p>
              <table border="1" cellpadding="5" style="border-collapse:collapse; margin-top:10px">
                <thead>
                  <tr><th>ë§¤ìˆ˜ì¼</th><th>ë§¤ë„ê°€</th><th>ìˆ˜ìµ(ì›)</th><th>ìˆ˜ìµë¥ (%)</th><th>ë³´ìœ ì¼</th></tr>
                </thead>
                <tbody>
                  ${trades.map(t => `<tr>
                    <td>${t.buyDate}</td>
                    <td>${t.sellPrice}</td>
                    <td>${t.profit.toFixed(0)}</td>
                    <td>${t.returnRate.toFixed(2)}</td>
                    <td>${t.holdDays}</td>
                  </tr>`).join('')}
                </tbody>
              </table>
            `;

            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        {
                            label: 'ì¢…ê°€',
                            data: closePrices,
                            borderColor: 'blue',
                            fill: false,
                            tension: 0.1
                        },
                        {
                            label: 'SMA10',
                            data: sma10,
                            borderColor: 'green',
                            fill: false,
                            tension: 0.1
                        },
                        {
                            label: 'SMA40',
                            data: sma40,
                            borderColor: 'red',
                            fill: false,
                            tension: 0.1
                        },
                        {
                            type: 'scatter',
                            label: 'ë§¤ìˆ˜ ì‹œì ',
                            data: buySignals,
                            backgroundColor: 'green',
                            pointStyle: 'triangle',
                            radius: 12
                        },
                        {
                            type: 'scatter',
                            label: 'ë§¤ë„ ì‹œì ',
                            data: sellSignals,
                            backgroundColor: 'red',
                            pointStyle: 'rectRot',
                            radius: 12
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: { display: true, title: { display: true, text: 'ì¼ì' } },
                        y: { display: true, title: { display: true, text: 'ê°€ê²©' } }
                    },
                    plugins: {
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        },
                        title: {
                            display: true,
                            text: 'ë¼ì˜¨ì‹œíì–´ ì¶”ì„¸ ì¶”ì¢… ì „ëµ ë§¤ë§¤ ì‹œì '
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
